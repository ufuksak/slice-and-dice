version: '3.7'

services:
  redis:
    image: redis:7.0.0
    healthcheck:
      test: [ "CMD-SHELL", "redis-cli ping | grep PONG" ]
      interval: 1s
      timeout: 3s
      retries: 5
    volumes:
      - ./redis/redis.conf:/usr/local/etc/redis/redis.conf
    ports:
      - '6378:6379'

  api:
    build:
      context: ../slice-and-dice
      target: builder
      dockerfile: Dockerfile
    ports:
      - 3002:3002
    environment:
      APP_NAME: slice-dice
      NODE_ENV: development
      PORT: 3002
      REDIS_HOST: localhost
      REDIS_PORT: 6378
      REDIS_PASSWORD:
      AWS_REGION: eu-west-1
    volumes:
      - ./src:/app/src
    command: npm run watch-node
    restart: on-failure
